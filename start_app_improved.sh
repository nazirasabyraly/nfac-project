#!/bin/bash

echo "๐ ะะฐะฟััะบ VibeMatch ะฟัะธะปะพะถะตะฝะธั..."

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะบะพัะฝะตะฒะพะน ะฟะฐะฟะบะต ะฟัะพะตะบัะฐ
if [ ! -d "backend" ] || [ ! -d "frontend" ]; then
    echo "โ ะะฐะฟัััะธัะต ัะบัะธะฟั ะธะท ะบะพัะฝะตะฒะพะน ะฟะฐะฟะบะธ ะฟัะพะตะบัะฐ"
    exit 1
fi

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ะธ ะพัะฒะพะฑะพะถะดะตะฝะธั ะฟะพััะฐ
check_and_free_port() {
    local port=$1
    local pids=$(lsof -ti:$port 2>/dev/null)
    if [ ! -z "$pids" ]; then
        echo "โ๏ธ  ะะพัั $port ะทะฐะฝัั. ะััะฐะฝะฐะฒะปะธะฒะฐั ะฟัะพัะตััั..."
        echo "$pids" | xargs kill -9 2>/dev/null
        sleep 2
    fi
}

# ะคัะฝะบัะธั ะดะปั ะพัะธััะบะธ ะฟัะธ ะฒััะพะดะต
cleanup() {
    echo ""
    echo "๐ ะััะฐะฝะพะฒะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    exit 0
}

# ะะตัะตัะฒะฐััะฒะฐะตะผ ัะธะณะฝะฐะป ะดะปั ะบะพััะตะบัะฝะพะณะพ ะทะฐะฒะตััะตะฝะธั
trap cleanup SIGINT SIGTERM

# ะัะพะฒะตััะตะผ ะธ ะพัะฒะพะฑะพะถะดะฐะตะผ ะฟะพััั
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ..."
check_and_free_port 8001
check_and_free_port 3000

# ะะฐะฟััะบะฐะตะผ ะฑัะบะตะฝะด
echo "๐ง ะะฐะฟััะบ ะฑัะบะตะฝะดะฐ..."
cd backend
if command -v python3 &> /dev/null; then
    python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload &
elif command -v python &> /dev/null; then
    python -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload &
else
    echo "โ Python ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi
BACKEND_PID=$!
cd ..

# ะะดะตะผ ะทะฐะฟััะบะฐ ะฑัะบะตะฝะดะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ะฑัะบะตะฝะดะฐ..."
sleep 5

# ะัะพะฒะตััะตะผ, ััะพ ะฑัะบะตะฝะด ะทะฐะฟัััะธะปัั
if ! curl -s http://localhost:8001/docs > /dev/null; then
    echo "โ ะัะบะตะฝะด ะฝะต ะทะฐะฟัััะธะปัั"
    exit 1
fi
echo "โ ะัะบะตะฝะด ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:8001"

# ะะฐะฟััะบะฐะตะผ ััะพะฝัะตะฝะด
echo "๐จ ะะฐะฟััะบ ััะพะฝัะตะฝะดะฐ..."
cd frontend
npm run dev &
FRONTEND_PID=$!
cd ..

# ะะดะตะผ ะทะฐะฟััะบะฐ ััะพะฝัะตะฝะดะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ััะพะฝัะตะฝะดะฐ..."
sleep 5

# ะัะพะฒะตััะตะผ, ััะพ ััะพะฝัะตะฝะด ะทะฐะฟัััะธะปัั
if ! curl -s http://localhost:3000 > /dev/null; then
    echo "โ ะคัะพะฝัะตะฝะด ะฝะต ะทะฐะฟัััะธะปัั"
    exit 1
fi
echo "โ ะคัะพะฝัะตะฝะด ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:3000"

echo ""
echo "๐ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!"
echo "๐ง ะัะบะตะฝะด: http://localhost:8001"
echo "๐จ ะคัะพะฝัะตะฝะด: http://localhost:3000"
echo "๐ API ะดะพะบัะผะตะฝัะฐัะธั: http://localhost:8001/docs"
echo ""
echo "ะะปั ะพััะฐะฝะพะฒะบะธ ะฝะฐะถะผะธัะต Ctrl+C"

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั
wait 